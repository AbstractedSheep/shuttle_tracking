<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Folder>
    <name>Vehicle Tracking</name>
    <description>http://vehicle-tracking.local</description>
    <!-- Constantly updating vehicle information -->
    <NetworkLink>
      <name>Vehicles</name>
      <description>Updating every 15 seconds</description>
      <refreshVisibility>0</refreshVisibility>
      <Link>
        <href><%= url_for :controller => :positions, :action => :current, :format => :kml, :only_path => false %></href>
        <refreshMode>onInterval</refreshMode>
        <refreshInterval>15</refreshInterval>
      </Link>
    </NetworkLink>
    
    <!-- Static route information-->
    <% @routes.each do |r| %>
    <NetworkLink id="route_<%= r.id %>">
      <name><%= r.name %></name>
      <description><![CDATA[ <%=h r.description %> ]]></description>
      <refreshVisibility>0</refreshVisibility>
      <Link>
        <href><%= url_for :controller => :routes, :action => :show, :id => r.id, :format => :kml, :only_path => false %></href>
      </Link>
    </NetworkLink>
    <% end %>
    
    <!-- Static stop information-->
    <Folder>
      <name>Stops</name>
      <% @stops.each do |s| %>
      <% routes = s.routes.collect{|r| h r.name} %>
      <Placemark id="stop_<%= s.id %>">
        <name><![CDATA[ <%= s.name %> ]]></name>
        <description><![CDATA[ Routes served: <%= routes.join(', ')%> ]]></description>
        <Point>
          <altitudeMode>clampToGround</altitudeMode>
          <coordinates><%= s.longitude %>,<%= s.latitude %>,0</coordinates>
        </Point>
      </Placemark>
      <% end %>
    </Folder>
  </Folder>
</kml>
